---
template: overrides/author.html
title: Buffer Overflow - Stack, ROP, Prevention
---

<aside class="mdx-author" markdown>
![@squidfunk][@squidfunk avatar]

<span>__suhao__ · @h40huynh</span>
<span>
:octicons-calendar-24: Aug 19, 2022 ·
:octicons-clock-24: 3 min read
</span>
</aside>

  [built-in search plugin]: ../../setup/setting-up-site-search.md#built-in-search-plugin
  [@squidfunk avatar]: ../assets/author/haoicon.png
  [insiders-4.14.0]: ../../insiders/changelog.md#4.14.0

---

## What is buffer overflow

Buffer overflow occurs when the amount of data in the buffer exceeds its storage capacity.

![](bof-introduce/stack.png)

## Stack registries and calling convention

**32bit calling convention**

When calling myFunction(a, b), the program will perform

```
push b
push a
push return address
```

![](bof-introduce/32bit--call-convention.png)

**64bit calling convention**

- Arguments 1st to6th are passed via registers RDI, RSI, RDX, RCX, R8, R9;
- Arguments 7 and above are pushed on to the stack.

![](bof-introduce/64bit--call-convention.png)

## Control EIP methods

Instead of using A's to fill the buffer, we can use a non-repeating strings

### cyclic

Create pattern

```bash
cyclic 100
```

Find offset (taaa is value of EIP when the program crashes)

```bash
cyclic -l taaa
```

### msf-pattern

```bash
msf-pattern_create -l 800
```

To finding the offset, we can use the following command (42306142 is value of EIP when the program crashes):

```bash
msf-pattern_offset -l 800 -q 42306142
```

## Buffer overflow prevention methods

### RELRO 

!!! info
    GOT: after use dynamic library, the address of dynamic library will save in GOT for next call.

**RELRO (Relocation Read-Only):** Makes the global offset table (GOT) read-only. This methods prevent from overwrite the function address in GOT.

### Stack canaries

**Stack canaries:** are tokens placed after a stack to detect a stack overflow.

### NX

**NX (non-executable):** When NX is enabled, the memory segments can be only writable or executable, not both. RWX will indicates that there are segments which can be read, written, and executed.

### PIE

**PIE (Position Independent Executable):** Load the program dependencies into random locations.

## ROP

Return Oriented Programming (or ROP) is 